{
  "version": "1.0.0",
  "title": "Delay should not impact processing",
  "description": "Inject latency into Lambda function execution and ensure files are still processed.",
  "tags": [
      "serverless",
      "cloudnative",
      "etl"
  ],
  "configuration": {
      "s3_bucket": {
          "type": "env",
          "key": "S3_BUCKET"
      },
      "sns_topic": {
          "type": "env",
          "key": "SNS_TOPIC"
      },
      "lambda_function": {
          "type": "env",
          "key": "LAMBDA_FUNCTION"
      }
  },
  "steady-state-hypothesis": {
      "title": "Services are all available and healthy",
      "probes": [
          {
              "type": "probe",
              "name": "zero-sns-errors",
              "tolerance": 0,
              "provider": {
                  "type": "python",
                  "module": "chaosaws.cloudwatch.probes",
                  "func": "get_metric_statistics",
                  "arguments": {
                      "namespace": "AWS/SNS",
                      "metric_name": "NumberOfNotificationsFailed",
                      "dimension_name": "TopicName",
                      "dimension_value": "${sns_topic}",
                      "statistic": "Sum",
                      "duration": 900
                  }
              }
          },
          {
              "type": "probe",
              "name": "zero-lambda-errors",
              "tolerance": 0,
              "provider": {
                  "type": "python",
                  "module": "chaosaws.cloudwatch.probes",
                  "func": "get_metric_statistics",
                  "arguments": {
                      "namespace": "AWS/Lambda",
                      "metric_name": "Errors",
                      "dimension_name": "FunctionName",
                      "dimension_value": "${lambda_function}",
                      "statistic": "Sum",
                      "duration": 300
                  }
              }
          }
      ]
  },
  "method": [
      {
          "type": "action",
          "name": "Enable Lambda failure: LATENCY",
          "provider": {
              "type": "process",
              "path": "aws",
              "arguments": "ssm put-parameter --name failureLambdaConfig --type String --overwrite --value '{\"isEnabled\": true, \"failureMode\": \"latency\", \"rate\": 0.5, \"minLatency\": 3000, \"maxLatency\": 4000, \"exceptionMsg\": \"Exception message!\", \"statusCode\": 404, \"diskSpace\": 100}'"
          },
          "pauses": {
              "after": 60
          }
      }
  ],
  "rollbacks": [
      {
          "type": "action",
          "name": "Disable Lambda failures",
          "provider": {
              "type": "process",
              "path": "aws",
              "arguments": "ssm put-parameter --name failureLambdaConfig --type String --overwrite --value '{\"isEnabled\": false, \"failureMode\": \"latency\", \"rate\": 0.5, \"minLatency\": 30, \"maxLatency\": 40, \"exceptionMsg\": \"Exception message!\", \"statusCode\": 404, \"diskSpace\": 100}'"
          }
      }
  ]
}
